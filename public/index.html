<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Twilio Dial Bridge (Silent + Keypad)</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;max-width:560px;margin:2rem auto}
input,button{width:100%;padding:.7rem;margin:.4rem 0;font-size:1rem;border:1px solid #ccc;border-radius:4px}
button{background:#0c8;color:#fff;cursor:pointer}
button[disabled]{background:#aaa;cursor:not-allowed}
#status{padding:.8rem;background:#f4f4f4;border-radius:4px;margin-top:1rem}
#pad{display:grid;grid-template-columns:repeat(3,1fr);gap:.4rem;margin-top:1rem}
#pad button{background:#333}
#pad button[disabled]{background:#666}
</style>
</head>
<body>
<h2>Browser ⇄ Phone Bridge (No Ringtone)</h2>

<input id="phone" type="tel" placeholder="+1##########"/>
<button id="callBtn"   disabled>Call</button>
<button id="endBtn"    disabled style="background:#d9534f">End Call</button>

<div id="pad"></div>
<div id="status">Loading Twilio Device…</div>

<script src="https://sdk.twilio.com/js/client/v1.13/twilio.min.js"></script>
<script>
(async () => {
  const S = id => document.getElementById(id);
  const status = S('status'), padDiv = S('pad');
  const callBtn=S('callBtn'), endBtn=S('endBtn'), phoneInp=S('phone');
  let activeConn=null, currentSid=null;

  // Build keypad UI (0-9 * #)
  const keys="123456789*0#".split('');
  keys.forEach(k=>{
    const b=document.createElement('button');
    b.textContent=k; b.disabled=true;
    b.onclick=()=> activeConn && activeConn.sendDigits(k);
    padDiv.appendChild(b);
  });
  const setPadEnabled = en =>
    [...padDiv.querySelectorAll('button')].forEach(b=>b.disabled=!en);

  // 1. fetch token
  const { token } = await fetch('/token').then(r=>r.json());

  // 2. Twilio Device setup with all sounds off
  Twilio.Device.setup(token,{debug:true,sounds:false});
  Twilio.Device.audio.incoming(false);
  Twilio.Device.audio.outgoing(false);
  Twilio.Device.audio.disconnect(false);

  Twilio.Device.on('ready', ()=>{
    status.textContent='Ready – enter a number, press Call';
    callBtn.disabled=false;
  });
  Twilio.Device.on('error', e=> status.textContent='Device error: '+e.message);

  // PSTN answers → Twilio calls our browser (‘incoming’)
  Twilio.Device.on('incoming', c=>{
    c.accept();
    activeConn=c; endBtn.disabled=false; setPadEnabled(true);
    status.textContent='Connected – speak!';
    c.on('disconnect', resetUI);
  });

  // Call PSTN via backend
  callBtn.onclick=async()=>{
    const num=phoneInp.value.trim();
    if(!num){status.textContent='Enter a valid number';return;}
    callBtn.disabled=true; status.textContent='Dialing…';

    const res=await fetch('/call',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({phoneNumber:num})
    }).then(r=>r.json());

    currentSid=res.callSid;
    endBtn.disabled=false;
  };

  // End call
  endBtn.onclick = async ()=>{
    if(currentSid) await fetch('/end-call',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({callSid:currentSid})
    });
    if(activeConn) activeConn.disconnect();
    resetUI();
  };

  function resetUI(){
    activeConn=null; currentSid=null; setPadEnabled(false);
    callBtn.disabled=false; endBtn.disabled=true;
    status.textContent='Ready';
  }
})();
</script>
</body>
</html>
