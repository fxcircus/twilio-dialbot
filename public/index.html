<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>‚òéÔ∏èü§ñ Dialbot</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;max-width:560px;margin:2rem auto}
input,button{width:100%;padding:.7rem;margin:.4rem 0;font-size:1rem;border:1px solid #ccc;border-radius:4px}
button{background:#0c8;color:#fff;cursor:pointer}
button[disabled]{background:#aaa;cursor:not-allowed}
#retryBtn{background:#f0ad4e}
#endBtn{background:#d9534f}
#status{padding:.8rem;background:#f4f4f4;border-radius:4px;margin-top:1rem}
#pad{display:grid;grid-template-columns:repeat(3,1fr);gap:.4rem;margin-top:1rem}
#pad button{background:#333}
#pad button[disabled]{background:#666}
</style>
</head>
<body>
<h2>Call Dialer</h2>

<input id="phone" type="tel" placeholder="+1##########"/>
<button id="callBtn"  disabled>Call</button>
<button id="endBtn"   disabled>End Call</button>
<button id="retryBtn" disabled>Hang-up & Redial</button>

<div id="pad"></div>
<div id="status">Loading Twilio Device‚Ä¶</div>

<script src="https://sdk.twilio.com/js/client/v1.13/twilio.min.js"></script>
<script>
(async () => {
  /* ----- DOM helpers ----- */
  const $ = id => document.getElementById(id);
  const status  = $('status'), padDiv=$('pad');
  const callBtn = $('callBtn'), endBtn=$('endBtn'), retryBtn=$('retryBtn');
  const phoneInp= $('phone');

  /* ----- State ----- */
  let activeConn=null, currentSid=null, lastNumber=null;
  let redialDelay=60000, redialTimer=null;

  /* 1Ô∏è‚É£  Fetch config + token */
  redialDelay = (await fetch('/config').then(r=>r.json())).redialDelayMs || 60000;
  const { token } = await fetch('/token').then(r=>r.json());

  /* 2Ô∏è‚É£  Twilio Device ‚Äì sounds off */
  Twilio.Device.setup(token,{debug:true,sounds:false});
  Twilio.Device.audio.incoming(false);
  Twilio.Device.audio.outgoing(false);
  Twilio.Device.audio.disconnect(false);

  Twilio.Device.on('ready', ()=>{ status.textContent='Ready'; callBtn.disabled=false; });
  Twilio.Device.on('error', e => status.textContent='Device error: '+e.message);

  /* 3Ô∏è‚É£  Incoming leg when callee answers */
  Twilio.Device.on('incoming', conn=>{
    conn.accept();
    activeConn=conn; endBtn.disabled=false; retryBtn.disabled=false; enablePad(true);
    status.textContent='Connected ‚Äì speak!';
    conn.on('disconnect', resetUI);
  });

  /* ----- Build DTMF keypad ----- */
  "123456789*0#".split('').forEach(k=>{
    const b=document.createElement('button');
    b.textContent=k; b.disabled=true;
    b.onclick=()=> activeConn && activeConn.sendDigits(k);
    padDiv.appendChild(b);
  });
  const enablePad = on => padDiv.querySelectorAll('button')
                               .forEach(btn=>btn.disabled=!on);

  /* ----- Call helpers ----- */
  async function startCall(num){
    lastNumber = num;
    callBtn.disabled = true;
    status.textContent = 'Dialing‚Ä¶';
    const res = await fetch('/call',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({phoneNumber:num})
    }).then(r=>r.json());
    currentSid = res.callSid;
    endBtn.disabled=false;
    retryBtn.disabled=false;
  }

  async function endCurrentCall(){
    if(currentSid){
      await fetch('/end-call',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({callSid:currentSid})
      });
    }
    if(activeConn) activeConn.disconnect();
  }

  function scheduleRedial(){
    status.textContent=`Redialing in ${redialDelay/1000}s‚Ä¶`;
    callBtn.disabled=true; retryBtn.disabled=true; endBtn.disabled=true; enablePad(false);
    redialTimer = setTimeout(()=>{ redialTimer=null; startCall(lastNumber); }, redialDelay);
  }

  function clearRedialTimer(){
    if(redialTimer){ clearTimeout(redialTimer); redialTimer=null; }
  }

  function resetUI(){
    clearRedialTimer();
    activeConn=currentSid=null;
    enablePad(false);
    callBtn.disabled=false; endBtn.disabled=true; retryBtn.disabled=true;
    status.textContent='Ready';
  }

  /* ----- Button handlers ----- */
  callBtn.onclick = () => {
    const num = phoneInp.value.trim();
    if(!num){ status.textContent='Enter a valid number'; return; }
    startCall(num);
  };

  endBtn.onclick = async () => {
    await endCurrentCall();
    resetUI();
  };

  retryBtn.onclick = async () => {
    if(!activeConn && !currentSid) return;  // safety
    await endCurrentCall();
    scheduleRedial();
  };
})();
</script>
</body>
</html>
